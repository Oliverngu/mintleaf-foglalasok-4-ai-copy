# Reservation + Seating/Allocation System — Current Baseline

> Scope: This document summarizes what the system does **today** based on code inspection. It is intentionally descriptive (not prescriptive) and avoids speculative behavior.

## A) What the system currently does (feature list)

### Guest booking flow (public UI + backend)
1. **Guest enters booking details** in `ReservationPage.tsx`, which uses `PublicReservationLayout.tsx` and themed styling (`reservationTheme`).
2. **Client submits booking** to the Cloud Function `guestCreateReservation` (functions/src/index.ts). Validation includes:
   - Required: `unitId`, start/end times, `reservation.name`, headcount (min/max), `reservation.contact.email`.
   - Headcount bounds enforced with `MIN_HEADCOUNT`/`MAX_HEADCOUNT`.
3. **Capacity decision** uses `decideAllocation` (capacity-oriented allocation engine) with optional allocation overrides read from `units/{unitId}/allocation_overrides/{dateKey}`.
4. **On accept**:
   - Booking is stored in `units/{unitId}/reservations/{bookingId}` with allocation intent/diagnostics/final fields, and capacity ledger updates.
   - `allocation_logs` is written via `writeAllocationAuditLog`.
   - `allocated` record is written (best-effort) via `computeAllocationDecisionForBooking` + `buildAllocationRecord`.
   - `writeAllocationDecisionLogForBooking` logs allocation engine details.
   - Emails are sent to guest/admin.
5. **On reject**:
   - If `CAPACITY_FULL`, returns HTTP 409 `{ error: 'capacity_full' }`.
   - Otherwise returns HTTP 400 `{ error: 'reservation_not_available' }`.
6. **Trace IDs**
   - Allocation audit log uses a `traceId` generated by `decideAllocation` and persisted as `allocationTraceId`.
   - Additional allocation logging uses `alloc-${bookingId}`.

### Guest manage flow (public manage page + backend)
- **ManageReservationPage.tsx** allows guests to cancel or request modifications via tokens.
- **Cancel flow** hits `guestUpdateReservation`:
  - Validates `unitId`, `reservationId`, `manageToken`, and action `cancel`.
  - Enforces rate limiting via `guest_rate_limits`.
  - Validates token hash (`manageTokenHash`) or legacy token match (`manageToken === reservationId`).
  - Prevents modifications to past reservations.
  - Updates status to `cancelled` and writes a reservation log entry.
  - Applies capacity ledger changes via `applyCapacityLedgerTx`.
- **Modify flow** hits `guestModifyReservation`:
  - Validates input, rate limits, and token hash.
  - Updates headcount/time, recomputes allocation diagnostics/intent, updates capacity ledger.
  - Writes allocation audit log.
  - Writes `allocated` record from the existing allocation decision (best-effort).
  - Returns `409 capacity_full` or `400` on rejection; otherwise returns updated booking info.

### Admin booking tools (FoglalasokApp)
- **Booking list & details** in `FoglalasokApp.tsx`:
  - Displays allocation intent/diagnostics/final and allocated result.
  - Shows a floorplan viewer (if admin) and allows highlighting zones/tables.
  - Provides a seating editor for assigning `zoneId` and `assignedTableIds`.
- **Seating settings** are opened via a dedicated modal (`SeatingSettingsModal.tsx`).
- **Reservation settings** open a separate modal (`ReservationSettingsModal.tsx` -> `ReservationSettingsForm.tsx`).

### Admin approve/reject via email token
- `adminHandleReservationAction` endpoint validates `adminToken` (hash/expiry/used) and updates status to `confirmed` or `cancelled`.
- Capacity ledger is updated and action details are persisted.

### Floorplan viewer behavior
- `FloorplanViewer.tsx` renders tables for the active floorplan, shows zones legend, highlights zone/table selections, and supports click callbacks.
- Highlight behavior:
  - `highlightTableIds` uses a stronger visual outline.
  - `highlightZoneId` highlights all tables within a zone.

## B) Data model snapshot

### Booking fields (selected)
- **Allocation intent** (`allocationIntent`): preferred time slot, zone, table group.
- **Allocation diagnostics** (`allocationDiagnostics`): intent quality, reasons, warnings, matched zone.
- **Allocation override** (`allocationOverride`): admin-selected override + metadata (enabled, zone/table/timeSlot/tableIds, note).
- **Allocation final** (`allocationFinal`): resolved allocation source (`intent` or `override`) and final selection; may be locked.
- **Allocated** (`allocated`): persisted allocation result written during create/modify.
  - Includes zone/table IDs, trace ID, `decidedAtMs`, strategy, diagnostics summary, computed-for metadata, and algorithm version.

### Seating settings (document path)
- **Firestore path:** `units/{unitId}/seating_settings/default`.
- Managed via `seatingAdminService` and read on the backend via `functions/src/allocation/queryReservations.ts`.
- Key fields include: `allocationEnabled`, `allocationMode`, `allocationStrategy`, `bufferMinutes`, `maxCombineCount`, `zonePriority`, `overflowZones`, `defaultZoneId`, and `emergencyZones` config.

### Zones, tables, combinations
- **Zones:** `units/{unitId}/zones` (fields: id, name, priority, isActive, isEmergency, tags, type).
- **Tables:** `units/{unitId}/tables` (fields: id, name, zoneId, capacityMin/Max, tableGroup, canCombine, geometry info).
- **Table combinations:** `units/{unitId}/table_combinations` (fields: id, tableIds, isActive).

### Capacity ledger
- **Reservation capacity docs** in `units/{unitId}/reservation_capacity/{dateKey}`.
- Contains total counts and optional breakdowns: `byTimeSlot`, `byZone`, `byTableGroup`, and `lastMutationTraceId`.

## C) Allocation pipeline (exact order)

### Capacity-based allocation (engine)
1. `decideAllocation` (functions/src/reservations/allocationEngine.ts)
   - Validates input.
   - Applies bookable window constraints.
   - Applies allocation override if enabled (`allocation_overrides/{dateKey}`).
   - Checks capacity limit vs current count.
2. In `guestCreateReservation` / `guestModifyReservation`:
   - If rejected, respond with error (409 for `CAPACITY_FULL`, otherwise 400).
   - If accepted, update reservation + capacity ledger via `applyCapacityLedgerTx`.

### Seating allocation + persisted allocation record
- In `guestCreateReservation`:
  - `computeAllocationDecisionForBooking` reads seating settings, zones, tables, combinations, and current reservation overlap.
  - `buildAllocationRecord` persists `allocated` to the reservation (best effort).
  - `writeAllocationDecisionLogForBooking` persists allocation decision log.
- In `guestModifyReservation`:
  - Uses the existing `allocationDecision` from the capacity flow to build an allocation summary and writes `allocated` (best effort).

### Allocation final/override composition
- Allocation intent + override data is composed into `allocationFinal` (`buildAllocationFinal`) and stored with `allocationFinalComputedAt` during create and override flows.

### Capacity ledger interaction
- `applyCapacityLedgerTx` computes slot deltas and updates `reservation_capacity` docs.
- `countsTowardCapacity` determines inclusion based on booking status.

## D) UI map (main screens/components)

### Public UI
- **ReservationPage.tsx**: booking wizard, guest form, submit to `guestCreateReservation`.
- **ManageReservationPage.tsx**: cancel/modify/approve/reject view using manage/admin tokens.
- **PublicReservationLayout.tsx**: shared layout wrapper for public pages.

### Admin UI
- **FoglalasokApp.tsx**: booking list, booking detail modal, allocation diagnostics display, seating editor, floorplan viewer, and allocation panel.
- **FloorplanViewer.tsx**: renders the active floorplan and table highlights.
- **SeatingSettingsModal.tsx**: full seating configuration UI (zones/tables/combinations/floorplans, allocation settings).
- **ReservationSettingsModal.tsx** / **ReservationSettingsForm.tsx**: reservation-level settings (not seating settings).

### Minimal seating settings panel
- The seating settings entry point is the **"Ültetés beállítások"** button in `FoglalasokApp.tsx`, which opens `SeatingSettingsModal.tsx`.

## E) Known gaps / UX pain points (code-observed)
> These are observations based on current code structure, not behavioral speculation.

- **Single large seating settings modal** handles zones, tables, combinations, floorplans, and allocation configuration in one place, which may be heavy to navigate.
- **Debug/diagnostic tools** (e.g., seating debug log) are gated behind dev/localStorage flags, making visibility inconsistent.
- **Allocation data presentation** in the booking details is mostly raw strings (zone/table IDs) without richer UI affordances (filters, badges, etc.).
- **Manage page flow** combines cancel/modify/admin actions in one page, which may increase cognitive load.

## F) Safe UI redesign boundaries (explicit)

The following UI changes are safe as long as backend logic and endpoints are untouched:
- Layout, styling, and component composition in `ReservationPage.tsx`, `ManageReservationPage.tsx`, `PublicReservationLayout.tsx`.
- Booking list/details UI in `FoglalasokApp.tsx` and any presentational components used there.
- Floorplan viewer layout and visuals in `FloorplanViewer.tsx` (without changing data fetching).
- Seating settings modal layout/presentation in `SeatingSettingsModal.tsx` (without altering service calls).
- Reservation settings UI (`ReservationSettingsModal.tsx` / `ReservationSettingsForm.tsx`) presentation.

> Non-negotiable: Do not alter backend endpoints, allocation decision logic, capacity ledger logic, or token validation behavior. UI can be redesigned around existing data structures.

## Firestore collections & docs referenced
- `reservation_settings/{unitId}` (public reservation settings)
- `units/{unitId}/reservations/{reservationId}`
- `units/{unitId}/reservation_logs/{logId}`
- `units/{unitId}/reservation_capacity/{dateKey}`
- `units/{unitId}/seating_settings/default`
- `units/{unitId}/zones/{zoneId}`
- `units/{unitId}/tables/{tableId}`
- `units/{unitId}/table_combinations/{comboId}`
- `units/{unitId}/allocation_overrides/{dateKey}`
- `allocation_logs/{docId}`

## Unknowns / follow-up inspection needed
- If any additional seating-related UI exists outside the files listed above, it was not found in this scan.
- If there are additional analytics dashboards or embedded widgets for allocation data, they were not inspected here.

