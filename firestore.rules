rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function canManageKnowledgeGlobal() {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.canManageKnowledgeBase == true ||
        request.auth.token.canManageKnowledgeCategories == true
      );
    }

    function canManageKnowledgeBase(unitId) {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.canManageKnowledgeBase == true ||
        request.auth.token.canManageKnowledgeCategories == true ||
        (request.auth.token.unitPermissions != null &&
          request.auth.token.unitPermissions[unitId].canManageKnowledgeBase == true) ||
        (request.auth.token.unitPermissions != null &&
          request.auth.token.unitPermissions[unitId].canManageKnowledgeCategories == true) ||
        (request.auth.token.permissions != null &&
          request.auth.token.permissions[unitId].canManageKnowledgeBase == true) ||
        (request.auth.token.permissions != null &&
          request.auth.token.permissions[unitId].canManageKnowledgeCategories == true)
      );
    }

    function canManageInventoryGlobal() {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.canManageInventory == true
      );
    }

    function canManageInventory(unitId) {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.canManageInventory == true ||
        (request.auth.token.unitPermissions != null &&
          request.auth.token.unitPermissions[unitId].canManageInventory == true) ||
        (request.auth.token.permissions != null &&
          request.auth.token.permissions[unitId].canManageInventory == true)
      );
    }

    // Fallback helper for environments without custom claims: allow signed-in users.
    function canAccessInventory(unitId) {
      return canManageInventory(unitId) || isSignedIn();
    }

    function canReadInventory(unitId) {
      return isSignedIn() && (
        canManageInventory(unitId) ||
        request.auth.token.canViewInventory == true ||
        (request.auth.token.unitPermissions != null &&
          request.auth.token.unitPermissions[unitId].canViewInventory == true) ||
        (request.auth.token.permissions != null &&
          request.auth.token.permissions[unitId].canViewInventory == true)
      );
    }

    // Tudástár: file meta (new), legacy knowledge_base docs, shared categories/notes
    match /knowledgeCategories/{docId} {
      allow read, write: if canManageKnowledgeGlobal();
    }

    match /knowledgeNotes/{docId} {
      allow read, write: if canManageKnowledgeGlobal();
    }

    match /units/{unitId}/files/{fileId} {
      allow read, write: if canManageKnowledgeBase(unitId);
    }

    match /units/{unitId}/knowledge_base/{document=**} {
      allow read, write: if canManageKnowledgeBase(unitId);
    }

    // Készlet (inventory) app: categories, products, stocks, suppliers
    match /units/{unitId}/inventoryCategories/{docId} {
      allow read: if canReadInventory(unitId) || isSignedIn();
      allow write: if canAccessInventory(unitId);
    }

    match /units/{unitId}/inventoryProducts/{docId} {
      allow read: if canReadInventory(unitId) || isSignedIn();
      allow write: if canAccessInventory(unitId);
    }

    match /units/{unitId}/inventoryIdealStocks/{docId} {
      allow read: if canReadInventory(unitId) || isSignedIn();
      allow write: if canAccessInventory(unitId);
    }

    match /units/{unitId}/inventoryCurrentStocks/{docId} {
      allow read: if canReadInventory(unitId) || isSignedIn();
      allow write: if canAccessInventory(unitId);
    }

    match /units/{unitId}/inventorySuppliers/{docId} {
      allow read: if canReadInventory(unitId) || isSignedIn();
      allow write: if canAccessInventory(unitId);
    }

    // Legacy catch-all: keep other app surfaces functional while authenticated.
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
