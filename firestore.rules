rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function userData() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data
        : {};
    }

    function userRole() {
      let d = userData();
      return d.role;
    }

    // unitIds + unitIDs (legacy) + unitId egyesítése
    function unitsFromData(d) {
      let u1 = d.unitIds;
      let u2 = d.unitIDs;
      let u3 = d.unitId;

      return u1 is list
        ? u1
        : (u1 is string
          ? [u1]
          : (u2 is list
            ? u2
            : (u2 is string
              ? [u2]
              : (u3 is string ? [u3] : []))));
    }

    function userUnits() {
      return unitsFromData(userData());
    }

    function sharesUnitWithUserDoc() {
      let targetUnits = unitsFromData(resource.data);
      return isSignedIn()
        && userUnits().size() > 0
        && targetUnits.size() > 0
        && userUnits().hasAny(targetUnits);
    }

    // <<< ITT VOLT A HIBA
    function hasUnit(unitId) {
      return isSignedIn()
        && unitId != null
        && userUnits().hasAny([unitId]);
    }

    function isAdmin() {
      return isSignedIn() && userRole() == 'Admin';
    }

    function isUnitAdmin() {
      return isSignedIn() && userRole() == 'Unit Admin';
    }

    function isUnitLeader() {
      return isSignedIn() && userRole() == 'Unit Leader';
    }

    function isEmployee() {
      return isSignedIn() && userRole() == 'User';
    }

    function canManageUnit(unitId) {
      return isAdmin() || (isUnitAdmin() && hasUnit(unitId));
    }

    function canViewUnit(unitId) {
      return isAdmin() || hasUnit(unitId);
    }

    function capacityFieldsAllowed() {
      return request.resource.data.keys().hasOnly(['date', 'count', 'limit', 'updatedAt']);
    }

    function capacityLimitTouched() {
      return 'limit' in request.resource.data;
    }

    function capacityLimitChanged() {
      return capacityLimitTouched()
        && (
          !('limit' in resource.data)
          || request.resource.data.limit != resource.data.limit
        );
    }

    function isSelf(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- users ---

    match /users/{userId} {
      // ADMIN is láthassa a többieket, különben nem lesz staff lista
      allow read: if isSelf(userId) || isAdmin() || sharesUnitWithUserDoc();

      allow create: if isAdmin()
        || (
          isSelf(userId)
          && request.resource.data.role in ['Unit Admin', 'Unit Leader', 'User', 'Guest', 'Demo User']
          && (
            !('unitIds' in request.resource.data)
            || request.resource.data.unitIds.size() == 0
          )
          && (
            !('unitIDs' in request.resource.data)
            || request.resource.data.unitIDs.size() == 0
          )
        );

      allow update: if isAdmin()
        || (
          isSelf(userId)
          && request.resource.data.role == resource.data.role
          && request.resource.data.unitIds == resource.data.unitIds
          && request.resource.data.unitIDs == resource.data.unitIDs
        );

      allow delete: if isAdmin();
    }

    // --- permissions / unit_permissions ---

    match /permissions/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /unit_permissions/{unitId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // --- units + subcollections ---

    match /units/{unitId} {
      // egységek meta – minden belépett user láthatja (selectorhez)
      allow read: if isSignedIn();
      allow write: if canManageUnit(unitId);

      match /reservations/{reservationId} {
        allow read: if canViewUnit(unitId);
        allow create: if canManageUnit(unitId)
          || (isUnitLeader() && hasUnit(unitId));
        allow update, delete: if canManageUnit(unitId)
          || (isUnitLeader() && hasUnit(unitId));
      }

      match /floorplans/{floorplanId} {
        allow read: if canManageUnit(unitId);
        allow create, update, delete: if canManageUnit(unitId);
      }

      match /reservation_capacity/{dateKey} {
        allow read: if true;
        allow create, update, delete: if false;
      }

      match /reservation_logs/{logId} {
        allow read: if canViewUnit(unitId);
        allow create, update, delete: if false;
      }

      match /files/{fileId} {
        allow read: if isSignedIn();
        allow create, update, delete: if canManageUnit(unitId)
          || (isUnitLeader() && hasUnit(unitId));
      }

      match /{path=**}/knowledge_base/{docId} {
        allow read: if isSignedIn();
        allow create, update, delete: if canManageUnit(unitId)
          || (isUnitLeader() && hasUnit(unitId));
      }

      match /chatMessages/{messageId} {
        allow read, create: if canViewUnit(unitId);
        allow update, delete: if canManageUnit(unitId)
          || (isSelf(resource.data.userId) && hasUnit(unitId));
      }

      match /typing/{typingId} {
        allow read, create, update, delete: if canViewUnit(unitId);
      }

      match /inventoryCategories/{categoryId} {
        allow read: if canViewUnit(unitId);
        allow create, update, delete: if canManageUnit(unitId)
          || (isUnitLeader() && hasUnit(unitId));
      }

      match /inventoryProducts/{productId} {
        allow read: if canViewUnit(unitId);
        allow create, update, delete: if canManageUnit(unitId)
          || (isUnitLeader() && hasUnit(unitId));
      }

      match /inventoryIdealStocks/{stockId} {
        allow read: if canViewUnit(unitId);
        allow create, update, delete: if canManageUnit(unitId)
          || (isUnitLeader() && hasUnit(unitId));
      }

      match /inventoryCurrentStocks/{stockId} {
        allow read: if canViewUnit(unitId);
        allow create, update, delete: if canManageUnit(unitId)
          || (isUnitLeader() && hasUnit(unitId));
      }

      match /inventorySuppliers/{supplierId} {
        allow read: if canViewUnit(unitId);
        allow create, update, delete: if canManageUnit(unitId)
          || (isUnitLeader() && hasUnit(unitId));
      }
    }

    // --- positions ---

    match /positions/{positionId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // --- invitations ---

    match /invitations/{inviteId} {
      allow read: if true;
      allow create, delete: if isAdmin()
        || (
          isUnitAdmin()
          && request.resource.data.unitId != null
          && hasUnit(request.resource.data.unitId)
        );

      allow update: if isAdmin()
        || (
          isUnitAdmin()
          && request.resource.data.unitId != null
          && hasUnit(request.resource.data.unitId)
        )
        || (
          isSignedIn()
          && resource.data.usedBy == null
          && request.resource.data.usedBy == request.auth.uid
        );
    }

    // --- todos ---

    match /todos/{todoId} {
      allow read: if isAdmin()
        || (
          isSignedIn()
          && (
            resource.data.unitId == null
            || hasUnit(resource.data.unitId)
          )
        );

      allow create: if isAdmin()
        || (
          isSignedIn()
          && (
            request.resource.data.unitId == null
            || hasUnit(request.resource.data.unitId)
          )
        );

      allow update, delete: if isAdmin()
        || (
          isSignedIn()
          && (
            resource.data.unitId == null
            || hasUnit(resource.data.unitId)
          )
        );
    }

    match /admin_todos/{todoId} {
      allow read, write: if isAdmin();
    }

    // --- shifts ---

    match /shifts/{shiftId} {
      allow read: if isAdmin()
        || (resource.data.unitId != null && hasUnit(resource.data.unitId));

      allow create: if isAdmin()
        || (
          (isUnitAdmin() || isUnitLeader())
          && request.resource.data.unitId != null
          && hasUnit(request.resource.data.unitId)
        );

      allow update, delete: if isAdmin()
        || (
          (isUnitAdmin() || isUnitLeader())
          && resource.data.unitId != null
          && hasUnit(resource.data.unitId)
        );
    }

    // --- requests (szabadság) ---

    match /requests/{requestId} {
      allow read: if isAdmin()
        || isSelf(resource.data.userId)
        || (
          (isUnitAdmin() || isUnitLeader())
          && resource.data.unitId != null
          && hasUnit(resource.data.unitId)
        );

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      allow update, delete: if isAdmin()
        || (
          (isUnitAdmin() || isUnitLeader())
          && resource.data.unitId != null
          && hasUnit(resource.data.unitId)
        )
        || (
          isSelf(resource.data.userId)
          && resource.data.status == 'pending'
        );
    }

    // --- time_entries ---

    match /time_entries/{entryId} {
      allow read: if isAdmin()
        || isSelf(resource.data.userId)
        || (resource.data.unitId != null && hasUnit(resource.data.unitId));

      allow create: if isAdmin()
        || isSelf(request.resource.data.userId)
        || (
          (isUnitAdmin() || isUnitLeader())
          && request.resource.data.unitId != null
          && hasUnit(request.resource.data.unitId)
        );

      allow update, delete: if isAdmin()
        || isSelf(resource.data.userId)
        || (
          (isUnitAdmin() || isUnitLeader())
          && resource.data.unitId != null
          && hasUnit(resource.data.unitId)
        );
    }

    // --- contacts ---

    match /contact_categories/{categoryId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /contacts/{contactId} {
      allow read: if isSignedIn()
        && (
          resource.data.unitId == null
          || hasUnit(resource.data.unitId)
          || isAdmin()
        );

      allow create: if isAdmin()
        || (
          isUnitAdmin()
          && request.resource.data.unitId != null
          && hasUnit(request.resource.data.unitId)
        );

      allow update, delete: if isAdmin()
        || (
          isUnitAdmin()
          && resource.data.unitId != null
          && hasUnit(resource.data.unitId)
        );
    }

    // --- Tudástár top-level (legacy) ---

    match /{path=**}/knowledge_base/{docId} {
      allow read: if isSignedIn();

      allow create: if isAdmin()
        || (
          request.resource.data.unitId != null
          && (
            canManageUnit(request.resource.data.unitId)
            || (isUnitLeader() && hasUnit(request.resource.data.unitId))
          )
        );

      allow update, delete: if isAdmin()
        || (
          resource.data.unitId != null
          && (
            canManageUnit(resource.data.unitId)
            || (isUnitLeader() && hasUnit(resource.data.unitId))
          )
        );
    }

    match /knowledgeCategories/{categoryId} {
      allow read: if isSignedIn();

      allow create: if isAdmin()
        || (
          request.resource.data.unitId != null
          && (
            canManageUnit(request.resource.data.unitId)
            || (isUnitLeader() && hasUnit(request.resource.data.unitId))
          )
        );

      allow update, delete: if isAdmin()
        || (
          resource.data.unitId != null
          && (
            canManageUnit(resource.data.unitId)
            || (isUnitLeader() && hasUnit(resource.data.unitId))
          )
        );
    }

    match /knowledgeNotes/{noteId} {
      allow read: if isSignedIn();

      allow create: if isAdmin()
        || (
          request.resource.data.unitId != null
          && (
            canManageUnit(request.resource.data.unitId)
            || (isUnitLeader() && hasUnit(request.resource.data.unitId))
          )
        );

      allow update, delete: if isAdmin()
        || (
          resource.data.unitId != null
          && (
            canManageUnit(resource.data.unitId)
            || (isUnitLeader() && hasUnit(resource.data.unitId))
          )
        );
    }

    // --- legacy files (top-level) ---

    match /units/{unitId}/knowledge_base/{fileId} {
      allow read: if isSignedIn();

      allow create, update, delete: if isAdmin()
        || (
          request.resource.data.unitId != null
          && (
            canManageUnit(request.resource.data.unitId)
            || (isUnitLeader() && hasUnit(request.resource.data.unitId))
          )
        );
    }

    // --- Polls + Votes ---

    match /polls/{pollId} {
      allow read: if isSignedIn();

      allow create: if isAdmin()
        || (
          request.resource.data.unitId != null
          && hasUnit(request.resource.data.unitId)
        );

      allow update, delete: if isAdmin()
        || (
          resource.data.unitId != null
          && hasUnit(resource.data.unitId)
        );

      match /{path=**}/votes/{voteId} {
        allow read: if isSignedIn()
          && (
            isAdmin()
            || (
              exists(/databases/$(database)/documents/polls/$(pollId))
              && hasUnit(get(/databases/$(database)/documents/polls/$(pollId)).data.unitId)
            )
          );

        allow create: if isSignedIn()
          && voteId == request.auth.uid
          && exists(/databases/$(database)/documents/polls/$(pollId))
          && hasUnit(get(/databases/$(database)/documents/polls/$(pollId)).data.unitId);

        allow update, delete: if isAdmin();
      }
    }

    // --- Feedback ---

    match /feedback/{feedbackId} {
      allow read: if isSignedIn();

      allow create: if isSignedIn()
        && request.resource.data.unitId != null
        && hasUnit(request.resource.data.unitId);

      allow update, delete: if isAdmin()
        || (
          isUnitAdmin()
          && resource.data.unitId != null
          && hasUnit(resource.data.unitId)
        );
    }

    // --- email queue / settings / templates ---

    match /email_queue/{emailId} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    match /reservation_settings/{unitId} {
      allow read: if true;
      allow write: if isAdmin()
        || (isUnitAdmin() && hasUnit(unitId));
    }

    match /email_settings/{unitId} {
      allow read, write: if isAdmin()
        || (isUnitAdmin() && hasUnit(unitId));
    }

    match /email_templates/{unitId} {
      allow read, write: if isAdmin()
        || (isUnitAdmin() && hasUnit(unitId));
    }

    match /schedule_display_settings/{settingsId} {
      allow read, write: if isSignedIn();
    }

    match /unit_export_settings/{unitId} {
      allow read: if canViewUnit(unitId);
      allow write: if canManageUnit(unitId);
    }

    match /schedule_settings/{settingsId} {
      allow read: if isSignedIn()
        && ((resource.data != null && resource.data.unitId != null
          && (canViewUnit(resource.data.unitId)
            || (isUnitLeader() && hasUnit(resource.data.unitId))
            || isAdmin()))
          || resource.data == null
          || (resource.data != null && resource.data.unitId == null));

      allow create: if request.resource.data.unitId != null
        && (
          canManageUnit(request.resource.data.unitId)
          || (isUnitLeader() && hasUnit(request.resource.data.unitId))
        );

      allow update: if request.resource.data.unitId != null
        && (
          canManageUnit(request.resource.data.unitId)
          || (isUnitLeader() && hasUnit(request.resource.data.unitId))
        );

      allow delete: if resource.data.unitId != null
        && (
          canManageUnit(resource.data.unitId)
          || (isUnitLeader() && hasUnit(resource.data.unitId))
        );
    }

    // --- user_private_data ---

    match /user_private_data/{userId} {
      allow read, write: if isSelf(userId) || isAdmin();
    }

    // Catch-all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
